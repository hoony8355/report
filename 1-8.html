<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>클라이언트 보고서 페이지</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f4f6f8; }
    h1 { margin-bottom: 10px; }
    .period { font-size: .9rem; color: #555; margin-bottom: 20px; }
    .term-toggle, .metric-toggle { margin-bottom: 15px; }
    .term-toggle button, .metric-toggle button { padding: 6px 12px; margin-right: 8px; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer; }
    .term-toggle button.active, .metric-toggle button.active { background:#3b82f6; color:#fff; border-color:#3b82f6; }
    .section { background:#fff; padding:20px; margin-bottom:30px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .charts { display:flex; gap:20px; margin-bottom:20px; }
    .chart-container { flex:1; }
    table.dataTable { width:100% !important; margin-bottom:20px; }
    textarea.insight { width:100%; height:80px; padding:10px; border:1px solid #ccc; border-radius:4px; }
    .dt-center { text-align:center; }
    .dt-right { text-align:right; }
  </style>
</head>
<body>
  <h1>Client A 보고서</h1>
  <div class="period">기간: 2025-07-31 ~ 2025-08-05</div>

  <!-- Sections -->
  <div id="sections"></div>

  <script>
    // 라벨 생성
    function getLastNDates(n) {
      const arr=[];
      const end=new Date('2025-08-05');
      for(let i=n-1;i>=0;i--){const d=new Date(end);d.setDate(end.getDate()-i);arr.push(d.toISOString().slice(0,10));}
      return arr;
    }
    const dailyDates = getLastNDates(7);
    const weeklyLabels = Array.from({length:8},(_,i)=>`W${i+1}`);

    // Sections and data
    const sections=['overall','Google','Meta','Naver','NaverGFA'];
    const mediaMap={ overall:['Google','Meta','Naver','Naver GFA'], Google:['Google'], Meta:['Meta'], Naver:['Naver'], NaverGFA:['Naver GFA'] };
    const sampleData={};
    sections.forEach(sec=>{
      sampleData[sec]={
        short:dailyDates.map(d=>({period:d})),
        long:weeklyLabels.map(d=>({period:d}))
      };
      ['short','long'].forEach(mode=>{
        sampleData[sec][mode]=sampleData[sec][mode].map(row=>{
          const spend=Math.floor(Math.random()*400000)+100000;
          const impr=Math.floor(spend*2+Math.random()*5000);
          const clicks=Math.floor(impr*(Math.random()*0.02+0.01));
          const conv=Math.floor(clicks*(Math.random()*0.2+0.05));
          const revenue=Math.floor(conv*(Math.random()*50000+20000));
          return {...row,spend,impr,clicks,conv,revenue,
            roas:+(revenue/spend*100).toFixed(1),
            cpm:+(spend/impr*1000).toFixed(1),
            cpc:clicks?+(spend/clicks).toFixed(1):0,
            ctr:+(clicks/impr*100).toFixed(2),
            cpa:conv?+(spend/conv).toFixed(1):0,
            cvr:clicks?+((conv/clicks)*100).toFixed(2):0
          };
        });
      });
    });
    const termMode=Object.fromEntries(sections.map(s=>[s,'short']));
    const metricMode=Object.fromEntries(sections.map(s=>[s,'cpm']));

    // Create section HTML
    function createSection(sec){
      const title = sec==='overall'?'전체':sec.replace('GFA',' GFA');
      const container=document.getElementById('sections');
      const div=document.createElement('div'); div.className='section'; div.id=`section-${sec}`;
      div.innerHTML=`
        <h2>${title}</h2>
        <div class='term-toggle' id='${sec}Toggle'>
          <button id='${sec}ShortBtn'>단기(7일)</button>
          <button id='${sec}LongBtn'>장기(8주)</button>
        </div>
        <div class='charts'>
          <div class='chart-container'><canvas id='${sec}TrendChart'></canvas></div>
          <div class='chart-container'>
            <div class='metric-toggle' id='${sec}MetricToggle'>
              <button id='${sec}CpmBtn'>CPM</button>
              <button id='${sec}CpcBtn'>CPC</button>
              <button id='${sec}CtrBtn'>CTR</button>
              <button id='${sec}CpaBtn'>CPA</button>
              <button id='${sec}CvrBtn'>CVR</button>
            </div>
            <canvas id='${sec}MetricChart'></canvas>
          </div>
        </div>
        <table id='${sec}DataTable' class='display'></table>
        <div><strong>인사이트 (${title}): </strong><textarea id='${sec}Insight' class='insight'>예시 인사이트입니다.</textarea></div>
      `;
      container.appendChild(div);
    }

    // Set term and metric
    function setTerm(sec,mode){ termMode[sec]=mode; document.getElementById(sec+'ShortBtn').classList.toggle('active',mode==='short'); document.getElementById(sec+'LongBtn').classList.toggle('active',mode==='long'); renderSection(sec); }
    function setMetric(sec,met){ metricMode[sec]=met; ['Cpm','Cpc','Ctr','Cpa','Cvr'].forEach(sfx=>document.getElementById(sec+sfx+'Btn').classList.toggle('active', sfx.toLowerCase()===met)); renderSection(sec); }

    // Render charts and table
    function renderSection(sec){
      const arr=sampleData[sec][termMode[sec]];
      const labels=arr.map(d=>d.period);
      // TrendChart
      new Chart(document.getElementById(sec+'TrendChart'),{ data:{ labels, datasets:[ {type:'bar',label:'Spend',data:arr.map(d=>d.spend),yAxisID:'y'}, {type:'line',label:'ROAS(%)',data:arr.map(d=>d.roas),yAxisID:'y1'} ] }, options:{responsive:true,scales:{y:{title:{display:true,text:'Spend'}},y1:{position:'right',title:{display:true,text:'ROAS(%)'}}}} });
      // MetricChart
      const met=metricMode[sec];
      new Chart(document.getElementById(sec+'MetricChart'),{ type:'line', data:{ labels, datasets:[{ label:met.toUpperCase(), data:arr.map(d=>d[met]) }] }, options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:met.toUpperCase()}}}} });
      // DataTable
      const total=arr.reduce((a,d)=>{['spend','impr','clicks','conv','revenue','roas','cpm','cpc','ctr','cpa','cvr'].forEach(k=>a[k]=(a[k]||0)+d[k]); return a;},{period:'총계'});
      const rows=[total,...arr];
      const dt=$('#'+sec+'DataTable').DataTable({ destroy:true, data:rows.map(r=>[ r.period, r.spend.toLocaleString(), r.impr.toLocaleString(), r.clicks.toLocaleString(), r.conv.toLocaleString(), r.revenue.toLocaleString(), r.roas, r.cpm, r.cpc, r.ctr, r.cpa, r.cvr ]), columns:[ {title:'기간'},{title:'광고비용'},{title:'노출수'},{title:'클릭수'},{title:'구매수'},{title:'매출액'},{title:'ROAS(%)'},{title:'CPM'},{title:'CPC'},{title:'CTR(%)'},{title:'CPA'},{title:'CVR(%)'} ], ordering:false,paging:false,info:false,searching:false });
      dt.columns().every(i=>{ $(dt.column(i).header()).css('text-align', i===0?'center':'right'); dt.column(i).nodes().to$().css('text-align', i===0?'center':'right'); });
    }

    document.addEventListener('DOMContentLoaded',()=>{
      sections.forEach(sec=>{
        createSection(sec);
        document.getElementById(sec+'ShortBtn').addEventListener('click',()=>setTerm(sec,'short'));
        document.getElementById(sec+'LongBtn').addEventListener('click',()=>setTerm(sec,'long'));
        ['Cpm','Cpc','Ctr','Cpa','Cvr'].forEach(sfx=>{
          document.getElementById(sec+sfx+'Btn').addEventListener('click',()=>setMetric(sec,sfx.toLowerCase()));
        });
        setTerm(sec,'short');
        setMetric(sec,'cpm');
      });
    });
  </script>
</body>
</html>
