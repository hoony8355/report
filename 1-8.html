<!DOCTYPE html>
<html lang='ko'>
<head>
  <meta charset='UTF-8'/>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'/>
  <title>클라이언트 보고서 페이지</title>
  <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
  <link rel='stylesheet' href='https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css'/>
  <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
  <script src='https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js'></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin:20px; background:#f4f6f8; }
    h1 { margin-bottom:10px; }
    .period { font-size:.9rem; color:#555; margin-bottom:20px; }
    .term-toggle, .metric-toggle { margin-bottom:15px; }
    .term-toggle button, .metric-toggle button { padding:6px 12px; margin-right:8px; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer; }
    .term-toggle button.active, .metric-toggle button.active { background:#3b82f6; color:#fff; border-color:#3b82f6; }
    .section { background:#fff; padding:20px; margin-bottom:30px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .charts { display:flex; gap:20px; margin-bottom:20px; }
    .chart-container { flex:1; }
    table.dataTable { width:100% !important; margin-bottom:20px; }
    textarea.insight { width:100%; height:80px; padding:10px; border:1px solid #ccc; border-radius:4px; }
    .dt-center { text-align:center; }
    .dt-right { text-align:right; }
  </style>
</head>
<body>
  <h1>Client A 보고서</h1>
  <div class='period'>기간: 2025-07-31 ~ 2025-08-05</div>

  <div id='sections'></div>

  <script>
    function getLastNDates(n) {
      const arr = [];
      const end = new Date('2025-08-05');
      for (let i = n - 1; i >= 0; i--) {
        const d = new Date(end);
        d.setDate(end.getDate() - i);
        arr.push(d.toISOString().slice(0,10));
      }
      return arr;
    }
    const dailyDates = getLastNDates(7);
    const weeklyLabels = Array.from({length:8}, (_,i)=>`W${i+1}`);

    const sections = ['overall','google','meta','naver','naverGfa'];
    const mediaMap = {
      overall:['Google','Meta','Naver','Naver GFA'],
      google:['Google'], meta:['Meta'], naver:['Naver'], naverGfa:['Naver GFA']
    };
    const sampleData = {};
    sections.forEach(sec=>{
      sampleData[sec] = { short:dailyDates.map(d=>({period:d})), long:weeklyLabels.map(d=>({period:d})) };
      ['short','long'].forEach(mode=>{
        sampleData[sec][mode] = sampleData[sec][mode].map(r=>{
          const spend = Math.floor(Math.random()*400000)+100000;
          const impr = Math.floor(spend*2 + Math.random()*5000);
          const clicks = Math.floor(impr*(Math.random()*0.02+0.01));
          const conv = Math.floor(clicks*(Math.random()*0.2+0.05));
          const revenue = Math.floor(conv*(Math.random()*50000+20000));
          return { period:r.period, spend, impr, clicks, conv, revenue,
            roas: +(revenue/spend*100).toFixed(1), cpm: +(spend/impr*1000).toFixed(1), cpc: clicks?+(spend/clicks).toFixed(1):0,
            ctr: +(clicks/impr*100).toFixed(2), cpa: conv?+(spend/conv).toFixed(1):0, cvr: clicks?+((conv/clicks)*100).toFixed(2):0
          };
        });
      });
    });
    const termMode = Object.fromEntries(sections.map(s=>[s,'short']));
    const metricMode = Object.fromEntries(sections.map(s=>[s,'cpm']));

    function createSectionHTML(sec) {
      const title = sec==='overall'?'전체':sec.charAt(0).toUpperCase()+sec.slice(1);
      return `
        <div class='section' id='section-${sec}'>
          <h2>${title}</h2>
          <div class='term-toggle'>
            <button id='${sec}-short'>단기(7일)</button>
            <button id='${sec}-long'>장기(8주)</button>
          </div>
          <div class='charts'>
            <div class='chart-container'><canvas id='${sec}-trend'></canvas></div>
            <div class='chart-container'>
              <div class='metric-toggle' id='${sec}-metric-toggle'>
                <button class='metric-btn' data-sec='${sec}' data-met='cpm'>CPM</button>
                <button class='metric-btn' data-sec='${sec}' data-met='cpc'>CPC</button>
                <button class='metric-btn' data-sec='${sec}' data-met='ctr'>CTR</button>
                <button class='metric-btn' data-sec='${sec}' data-met='cpa'>CPA</button>
                <button class='metric-btn' data-sec='${sec}' data-met='cvr'>CVR</button>
              </div>
              <canvas id='${sec}-metric'></canvas>
            </div>
          </div>
          <table id='${sec}-table' class='display'></table>
          <div><strong>인사이트 (${title}):</strong>
            <textarea class='insight'>예시 인사이트입니다.</textarea>
          </div>
        </div>
      `;
    }
    document.getElementById('sections').innerHTML = sections.map(createSectionHTML).join('');

    const trendCharts = {}, metricCharts = {}, dataTables = {};

    function updateSection(sec) {
      const arr = sampleData[sec][termMode[sec]];
      const labels = arr.map(d=>d.period);
      // Trend
      trendCharts[sec].data.labels = labels;
      trendCharts[sec].data.datasets[0].data = arr.map(d=>d.spend);
      trendCharts[sec].data.datasets[1].data = arr.map(d=>d.roas);
      trendCharts[sec].update();
      // Metric
      const met = metricMode[sec];
      metricCharts[sec].data.labels = labels;
      metricCharts[sec].data.datasets[0].label = met.toUpperCase();
      metricCharts[sec].data.datasets[0].data = arr.map(d=>d[met]);
      metricCharts[sec].options.scales.y.title.text = met.toUpperCase();
      metricCharts[sec].update();
      // Table
      const total = arr.reduce((a,d)=>{['spend','impr','clicks','conv','revenue','roas','cpm','cpc','ctr','cpa','cvr'].forEach(k=>a[k]=(a[k]||0)+d[k]);return a;},{period:'총계'});
      const rows = [total, ...arr];
      const dt = dataTables[sec];
      dt.clear(); rows.forEach(r=> dt.row.add([
        r.period, r.spend.toLocaleString(), r.impr.toLocaleString(), r.clicks.toLocaleString(), r.conv.toLocaleString(), r.revenue.toLocaleString(),
        r.roas, r.cpm, r.cpc, r.ctr, r.cpa, r.cvr
      ])); dt.draw();
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      sections.forEach(sec=>{
        // init charts
        const tctx = document.getElementById(`${sec}-trend`).getContext('2d');
        trendCharts[sec] = new Chart(tctx,{ data:{labels:[],datasets:[{type:'bar',label:'Spend',data:[],yAxisID:'y'},{type:'line',label:'ROAS(%)',data:[],yAxisID:'y1'}]},options:{responsive:true,scales:{y:{title:{display:true,text:'Spend'}},y1:{position:'right',title:{display:true,text:'ROAS(%)'},grid:{drawOnChartArea:false}}}} });
        const mctx = document.getElementById(`${sec}-metric`).getContext('2d');
        metricCharts[sec] = new Chart(mctx,{type:'line',data:{labels:[],datasets:[{label:'CPM',data:[],borderColor:'rgba(75,192,192,1)',fill:false}]},options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'CPM'}}}}});
        // init table
        dataTables[sec] = $(`#${sec}-table`).DataTable({ columns:[{title:'기간'},{title:'광고비용',className:'dt-right'},{title:'노출수',className:'dt-right'},{title:'클릭수',className:'dt-right'},{title:'구매수',className:'dt-right'},{title:'매출액',className:'dt-right'},{title:'ROAS(%)',className:'dt-right'},{title:'CPM',className:'dt-right'},{title:'CPC',className:'dt-right'},{title:'CTR(%)',className:'dt-right'},{title:'CPA',className:'dt-right'},{title:'CVR(%)',className:'dt-right'}],ordering:false,paging:false,info:false,searching:false});
        // bind term toggles
        document.getElementById(`${sec}-short`).addEventListener('click', ()=>{termMode[sec]='short'; document.getElementById(`${sec}-short`).classList.add('active'); document.getElementById(`${sec}-long`).classList.remove('active'); updateSection(sec);});
        document.getElementById(`${sec}-long`).addEventListener('click', ()=>{termMode[sec]='long'; document.getElementById(`${sec}-long`).classList.add('active'); document.getElementById(`${sec}-short`).classList.remove('active'); updateSection(sec);});
        // bind metric toggles
        document.querySelectorAll(`#${sec}-metric-toggle .metric-btn`).forEach(btn=>{btn.addEventListener('click', ()=>{const m=btn.dataset.met; metricMode[sec]=m; document.querySelectorAll(`#${sec}-metric-toggle .metric-btn`).forEach(b=>b.classList.remove('active')); btn.classList.add('active'); updateSection(sec);});});
        // initial active
        document.getElementById(`${sec}-short`).classList.add('active');
        document.querySelector(`#${sec}-metric-toggle .metric-btn[data-met='cpm']`).classList.add('active');
        updateSection(sec);
      });
    });
  </script>
</body>
</html>
