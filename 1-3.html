<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>클라이언트 보고서 페이지</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f4f6f8; }
    h1 { margin-bottom: 5px; }
    .period { font-size: .9rem; color: #555; margin-bottom: 15px; }
    .term-toggle { margin-bottom: 15px; }
    .term-toggle button { padding: 6px 12px; margin-right: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; }
    .term-toggle button.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
    .section { background: #fff; padding: 20px; margin-bottom: 30px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section h2 { margin-top: 0; }
    .charts { display: flex; gap: 20px; margin-bottom: 20px; }
    .chart-container { flex: 1; }
    table.dataTable { width: 100% !important; margin-bottom: 20px; }
    #periodTable th, #periodTable td { padding: 8px; border: 1px solid #ddd; }
    #periodTable { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    #periodTable th { background: #eef1f7; }
    textarea.insight { width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    .dt-center { text-align: center; }
    .dt-right  { text-align: right; }
  </style>
</head>
<body>
  <h1>Client A 보고서</h1>
  <div class="period">기간: 2025-07-31 ~ 2025-08-05</div>

  <!-- 전체 + 매체별 공통 구조 -->
  <script>
    // 유틸: 지난 N일 날짜 배열, 8주차 레이블 생성
    function getLastNDates(n) {
      const arr = [];
      const today = new Date('2025-08-05');
      for (let i = n - 1; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        arr.push(d.toISOString().slice(0,10));
      }
      return arr;
    }
    const dailyDates = getLastNDates(7);
    const weeklyLabels = Array.from({length:8}, (_,i)=>`W${i+1}`);
  </script>

  <script>
    // 샘플 데이터: 각 섹션별로 단기(short)/장기(long) 시계열 생성
    const sections = ['overall','Google','Meta','Naver','NaverGFA'];
    const mediaMap = {
      overall: ['Google','Meta','Naver','Naver GFA'],
      Google:  ['Google'],
      Meta:    ['Meta'],
      Naver:   ['Naver'],
      NaverGFA:['Naver GFA']
    };
    const sampleData = {};
    sections.forEach(sec => {
      sampleData[sec] = {
        short: dailyDates.map(date => {
          const spend   = Math.floor(Math.random()*400000)+100000;
          const revenue = Math.floor(spend*(1+Math.random()));
          return { period: date, spend, revenue, roas: +(revenue/spend*100).toFixed(1) };
        }),
        long: weeklyLabels.map(w => {
          const spend   = Math.floor(Math.random()*2000000)+500000;
          const revenue = Math.floor(spend*(1+Math.random()));
          return { period: w, spend, revenue, roas: +(revenue/spend*100).toFixed(1) };
        })
      };
    });
    // 토글 모드 저장
    const termMode = Object.fromEntries(sections.map(s=>[s,'short']));
  </script>

  <script>
    // 각 섹션 DOM 생성
    sections.forEach(sec => {
      const human = sec==='overall' ? '전체' : sec.replace(/GFA$/, 'GFA').replace(/([A-Z])/g,' $1').trim();
      document.write(`
        <div class="section" id="section-${sec}">
          <h2>${human}</h2>
          <div class="term-toggle" id="${sec}Toggle">
            <button id="${sec}ShortBtn">단기(1주일)</button>
            <button id="${sec}LongBtn">장기(8주)</button>
          </div>
          <div class="charts">
            <div class="chart-container"><canvas id="${sec}TrendChart"></canvas></div>
            <div class="chart-container"><canvas id="${sec}ChannelChart"></canvas></div>
          </div>
          <table id="${sec}MediaTable" class="display"></table>
          <table id="${sec}PeriodTable">
            <thead><tr id="${sec}PeriodHeader"></tr></thead>
            <tbody></tbody>
          </table>
          <div><strong>인사이트 (${human}):</strong>
            <textarea id="${sec}Insight" class="insight" placeholder="${human} 인사이트를 작성하세요..."></textarea>
          </div>
        </div>
      `);
    });
  </script>

  <script>
    // 토글 버튼 & 렌더링 함수
    function renderSection(sec) {
      const mode = termMode[sec];
      const dataArr = sampleData[sec][mode];
      // Trend Chart
      const labels = dataArr.map(d=>d.period);
      const spend  = dataArr.map(d=>d.spend);
      const roas   = dataArr.map(d=>d.roas);
      new Chart(document.getElementById(`${sec}TrendChart`), {
        data: {
          labels,
          datasets: [
            { type:'bar',  label:'Spend',   data:spend, yAxisID:'y',  backgroundColor:'rgba(59,123,246,0.5)' },
            { type:'line', label:'ROAS(%)', data:roas,  yAxisID:'y1', borderColor:'rgba(246,88,59,0.8)', fill:false }
          ]
        },
        options: {
          responsive:true,
          scales: {
            y:  { title:{display:true,text:'Spend'} },
            y1: { position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'ROAS(%)'} }
          }
        }
      });
      // Channel Chart (전체 섹션은 all medias, 개별 섹션은 단일 media)
      const medias = mediaMap[sec].map(m=> m==='NaverGFA'?'Naver GFA':m);
      const channelSpend = medias.map(m=> dataArr.filter(d=> d.period && m).reduce((s,d)=> s+d.spend,0));
      const channelRev   = medias.map(m=> dataArr.filter(d=> d.period && m).reduce((s,d)=> s+d.revenue,0));
      new Chart(document.getElementById(`${sec}ChannelChart`), {
        data: {
          labels: medias,
          datasets: [
            { label:'Spend',   type:'bar', data:channelSpend,   yAxisID:'y',  backgroundColor:'rgba(59,146,64,0.6)' },
            { label:'Revenue', type:'bar', data:channelRev,     yAxisID:'y1', backgroundColor:'rgba(64,150,199,0.6)' }
          ]
        },
        options:{
          responsive:true,
          scales:{
            y:  { title:{display:true,text:'Spend'} },
            y1: { position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'Revenue'} }
          }
        }
      });
      // Media Table
      const table = $(`#${sec}MediaTable`).DataTable({
        data: medias.map((m,i)=>[ 'Client A', m, channelSpend[i].toLocaleString(), channelRev[i].toLocaleString(), '—' ]),
        columns:[
          { title:'Client', className:'dt-center' },
          { title:'Media',  className:'dt-center' },
          { title:'Spend',  className:'dt-right' },
          { title:'Revenue',className:'dt-right' },
          { title:'ROAS(%)',className:'dt-right' }
        ],
        ordering:false, paging:false, info:false, searching:false,
        destroy:true
      });
      // Period Table
      const tbody = document.querySelector(`#${sec}PeriodTable tbody`);
      const thead = document.getElementById(`${sec}PeriodHeader`);
      thead.innerHTML = `
        <th class="dt-center">Period</th>
        <th class="dt-right">Spend</th>
        <th class="dt-right">Revenue</th>
        <th class="dt-right">ROAS(%)</th>`;
      tbody.innerHTML = dataArr.map(d=>`
        <tr>
          <td class="dt-center">${d.period}</td>
          <td class="dt-right">${d.spend.toLocaleString()}</td>
          <td class="dt-right">${d.revenue.toLocaleString()}</td>
          <td class="dt-right">${d.roas.toLocaleString()}</td>
        </tr>
      `).join('');
    }

    // 초기화
    $(document).ready(function(){
      sections.forEach(sec=>{
        $(`#${sec}ShortBtn`).addClass('active');
        $(`#${sec}ShortBtn, #${sec}LongBtn`).click(function(){
          termMode[sec] = this.id.endsWith('ShortBtn') ? 'short' : 'long';
          $(`#${sec}Toggle button`).removeClass('active');
          $(this).addClass('active');
          renderSection(sec);
        });
        renderSection(sec);
      });
    });
  </script>
</body>
</html>
