<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>클라이언트 보고서 페이지</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f4f6f8; }
    h1 { margin-bottom: 5px; }
    .period { font-size: 0.9rem; color: #555; margin-bottom: 15px; }
    .term-toggle { margin-bottom: 15px; }
    .term-toggle button { padding: 6px 12px; margin-right: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; }
    .term-toggle button.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
    .section { background: #fff; padding: 20px; margin-bottom: 30px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section h2 { margin-top: 0; }
    .charts { display: flex; gap: 20px; margin-bottom: 20px; }
    .chart-container { flex: 1; }
    table.dataTable { width: 100% !important; margin-bottom: 20px; }
    #periodTable th, #periodTable td { padding: 8px; border: 1px solid #ddd; }
    #periodTable { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    #periodTable th { background: #eef1f7; }
    textarea.insight { width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    .dt-center { text-align: center; }
    .dt-right { text-align: right; }
  </style>
</head>
<body>
  <h1>Client A 보고서</h1>
  <div class="period">기간: 2025-07-31 ~ 2025-08-05</div>

  <script>
    function getLastNDates(n) {
      const arr = [];
      const end = new Date('2025-08-05');
      for (let i = n - 1; i >= 0; i--) {
        const d = new Date(end);
        d.setDate(end.getDate() - i);
        arr.push(d.toISOString().slice(0,10));
      }
      return arr;
    }
    const dailyDates = getLastNDates(7);
    const weeklyLabels = Array.from({length:8},(_,i)=>`W${i+1}`);
  </script>

  <script>
    const sections = ['overall','Google','Meta','Naver','NaverGFA'];
    const mediaMap = {
      overall: ['Google','Meta','Naver','Naver GFA'],
      Google: ['Google'], Meta: ['Meta'], Naver: ['Naver'], NaverGFA: ['Naver GFA']
    };
    const sampleData = {};
    sections.forEach(sec => {
      sampleData[sec] = {
        short: dailyDates.map(date => {
          const spend = Math.floor(Math.random()*400000)+100000;
          const impr  = Math.floor(spend*2 + Math.random()*10000);
          const clicks= Math.floor(impr*(Math.random()*0.02+0.01));
          const conv  = Math.floor(clicks*(Math.random()*0.2+0.05));
          const revenue = Math.floor(conv*(Math.random()*50000+20000));
          return {
            period: date,
            spend, impr, clicks, conv, revenue,
            roas: +(revenue/spend*100).toFixed(1),
            cpm: +(spend/impr*1000).toFixed(1),
            cpc: clicks?+(spend/clicks).toFixed(1):0,
            ctr: +(clicks/impr*100).toFixed(2),
            cpa: conv?+(spend/conv).toFixed(1):0,
            cvr: clicks?+((conv/clicks)*100).toFixed(2):0
          };
        }),
        long: weeklyLabels.map(w => {
          const spend = Math.floor(Math.random()*2000000)+500000;
          const impr  = Math.floor(spend*2 + Math.random()*50000);
          const clicks= Math.floor(impr*(Math.random()*0.02+0.01));
          const conv  = Math.floor(clicks*(Math.random()*0.2+0.05));
          const revenue = Math.floor(conv*(Math.random()*50000+20000));
          return {
            period: w,
            spend, impr, clicks, conv, revenue,
            roas: +(revenue/spend*100).toFixed(1),
            cpm: +(spend/impr*1000).toFixed(1),
            cpc: clicks?+(spend/clicks).toFixed(1):0,
            ctr: +(clicks/impr*100).toFixed(2),
            cpa: conv?+(spend/conv).toFixed(1):0,
            cvr: clicks?+((conv/clicks)*100).toFixed(2):0
          };
        })
      };
    });
    const termMode = Object.fromEntries(sections.map(s=>[s,'short']));
  </script>

  <script>
    // HTML 섹션 생성
    sections.forEach(sec => {
      const title = sec==='overall'?'전체':sec.replace('GFA',' GFA');
      document.write(`
        <div class="section" id="section-${sec}">
          <h2>${title}</h2>
          <div class="term-toggle" id="${sec}Toggle">
            <button id="${sec}ShortBtn">단기(1주)</button>
            <button id="${sec}LongBtn">장기(8주)</button>
          </div>
          <div class="charts">
            <div class="chart-container"><canvas id="${sec}TrendChart"></canvas></div>
            <div class="chart-container"><canvas id="${sec}ChannelChart"></canvas></div>
          </div>
          <table id="${sec}MediaTable" class="display"></table>
          <table id="${sec}PeriodTable">
            <thead><tr id="${sec}PeriodHeader"></tr></thead>
            <tbody></tbody>
          </table>
          <div><strong>인사이트 (${title}):</strong>
            <textarea id="${sec}Insight" class="insight" placeholder="${title} 인사이트 작성..."></textarea>
          </div>
        </div>
      `);
    });
  </script>

  <script>
    function renderSection(sec) {
      const arr = sampleData[sec][termMode[sec]];
      const labels = arr.map(d=>d.period);
      const spend  = arr.map(d=>d.spend);
      const roas   = arr.map(d=>d.roas);

      // Trend Chart
      new Chart(document.getElementById(`${sec}TrendChart`),{
        data:{ labels, datasets:[
          { type:'bar', label:'광고비용', data:spend, yAxisID:'y', backgroundColor:'rgba(59,123,246,0.5)' },
          { type:'line',label:'ROAS(%)',  data:roas, yAxisID:'y1', borderColor:'rgba(246,88,59,0.8)', fill:false }
        ] },
        options:{ responsive:true, scales:{
          y:  { title:{display:true,text:'광고비용'} },
          y1: { position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'ROAS(%)'} }
        }}
      });

      // Channel Chart
      const mediaList = mediaMap[sec];
      const channelSpend = mediaList.map(m=>arr.filter(d=>d.period).reduce((s,d)=>s+d.spend,0));
      const channelRev   = mediaList.map(m=>arr.filter(d=>d.period).reduce((s,d)=>s+d.revenue,0));
      new Chart(document.getElementById(`${sec}ChannelChart`),{
        data:{ labels:mediaList, datasets:[
          { label:'광고비용', type:'bar', data:channelSpend, yAxisID:'y', backgroundColor:'rgba(59,146,64,0.6)' },
          { label:'매출액',   type:'bar', data:channelRev,   yAxisID:'y1', backgroundColor:'rgba(64,150,199,0.6)' }
        ] },
        options:{ responsive:true, scales:{
          y:  { title:{display:true,text:'광고비용'} },
          y1: { position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'매출액'} }
        }}
      });

      // Media Summary Table
      const dt = $(`#${sec}MediaTable`).DataTable({ destroy:true });
      dt.clear();
      mediaList.forEach(m=>{
        const grp = arr.filter(d=>d.period);
        dt.row.add([
          'Client A', m,
          grp.reduce((s,d)=>s+d.spend,0).toLocaleString(),
          grp.reduce((s,d)=>s+d.impr,0).toLocaleString(),
          grp.reduce((s,d)=>s+d.clicks,0).toLocaleString(),
          grp.reduce((s,d)=>s+d.conv,0).toLocaleString(),
          grp.reduce((s,d)=>s+d.revenue,0).toLocaleString(),
          (grp.reduce((s,d)=>s+d.roas,0)/grp.length).toFixed(1),
          (grp.reduce((s,d)=>s+d.cpm,0)/grp.length).toFixed(1),
          (grp.reduce((s,d)=>s+d.cpc,0)/grp.length).toFixed(1),
          (grp.reduce((s,d)=>s+d.ctr,0)/grp.length).toFixed(2),
          (grp.reduce((s,d)=>s+d.cpa,0)/grp.length).toFixed(1),
          (grp.reduce((s,d)=>s+d.cvr,0)/grp.length).toFixed(2)
        ]);
      });
      dt.draw();

      // Raw Data Table with all metrics
      const tbody = document.querySelector(`#${sec}PeriodTable tbody`);
      const thead = document.getElementById(`${sec}PeriodHeader`);
      thead.innerHTML = `
        <th class="dt-center">기간</th>
        <th class="dt-right">광고비용</th>
        <th class="dt-right">노출수</th>
        <th class="dt-right">클릭수</th>
        <th class="dt-right">구매수</th>
        <th class="dt-right">매출액</th>
        <th class="dt-right">ROAS(%)</th>
        <th class="dt-right">CPM</th>
        <th class="dt-right">CPC</th>
        <th class="dt-right">CTR(%)</th>
        <th class="dt-right">CPA</th>
        <th class="dt-right">CVR(%)</th>
      `;
      tbody.innerHTML = arr.map(d=>`
        <tr>
          <td class="dt-center">${d.period}</td>
          <td class="dt-right">${d.spend.toLocaleString()}</td>
          <td class="dt-right">${d.impr.toLocaleString()}</td>
          <td class="dt-right">${d.clicks.toLocaleString()}</td>
          <td class="dt-right">${d.conv.toLocaleString()}</td>
          <td class="dt-right">${d.revenue.toLocaleString()}</td>
          <td class="dt-right">${d.roas.toLocaleString()}</td>
          <td class="dt-right">${d.cpm.toLocaleString()}</td>
          <td class="dt-right">${d.cpc.toLocaleString()}</td>
          <td class="dt-right">${d.ctr.toLocaleString()}</td>
          <td class="dt-right">${d.cpa.toLocaleString()}</td>
          <td class="dt-right">${d.cvr.toLocaleString()}</td>
        </tr>
      `).join('');
    }

    $(document).ready(()=>{
      // DataTables 초기화
      sections.forEach(sec=>{
        $(`#${sec}MediaTable`).DataTable({
          columns: [
            { title:'Client',  className:'dt-center' },
            { title:'Media',   className:'dt-center' },
            { title:'Spend',   className:'dt-right' },
            { title:'Impr.',   className:'dt-right' },
            { title:'Clicks',  className:'dt-right' },
            { title:'Conv.',   className:'dt-right' },
            { title:'Revenue', className:'dt-right' },
            { title:'ROAS',    className:'dt-right' },
            { title:'CPM',     className:'dt-right' },
            { title:'CPC',     className:'dt-right' },
            { title:'CTR',     className:'dt-right' },
            { title:'CPA',     className:'dt-right' },
            { title:'CVR',     className:'dt-right' }
          ],
          ordering:false, paging:false, info:false, searching:false
        });
        // 토글 버튼 이벤트
        $(`#${sec}ShortBtn, #${sec}LongBtn`).click(function(){
          termMode[sec] = this.id.endsWith('ShortBtn')?'short':'long';
          $(`#${sec}Toggle button`).removeClass('active');
          $(this).addClass('active');
          renderSection(sec);
        });
        $(`#${sec}ShortBtn`).addClass('active');
        renderSection(sec);
      });
    });
  </script>
</body>
</html>
