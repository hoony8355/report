<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>클라이언트 보고서 페이지</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f4f6f8; }
    h1 { margin-bottom: 5px; }
    .period { font-size: 0.9rem; color: #555; margin-bottom: 15px; }
    .term-toggle { margin-bottom: 15px; }
    .term-toggle button { padding: 6px 12px; margin-right: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; }
    .term-toggle button.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
    .section { background: #fff; padding: 20px; margin-bottom: 30px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section h2 { margin-top: 0; }
    .charts { display: flex; gap: 20px; margin-bottom: 20px; }
    .chart-container { flex: 1; }
    table.dataTable { width: 100% !important; margin-bottom: 20px; }
    #periodTable th, #periodTable td { padding: 8px; border: 1px solid #ddd; }
    #periodTable { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    #periodTable th { background: #eef1f7; }
    textarea.insight { width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    .dt-center { text-align: center; }
    .dt-right  { text-align: right; }
  </style>
</head>
<body>
  <h1>Client A 보고서</h1>
  <div class="period">기간: 2025-07-31 ~ 2025-08-05</div>

  <script>
    function getLastNDates(n) {
      const arr = [];
      const end = new Date('2025-08-05');
      for (let i = n - 1; i >= 0; i--) {
        const d = new Date(end);
        d.setDate(end.getDate() - i);
        arr.push(d.toISOString().slice(0,10));
      }
      return arr;
    }
    const dailyDates = getLastNDates(7);
    const weeklyLabels = Array.from({length:8}, (_,i) => `W${i+1}`);
  </script>

  <script>
    // 섹션 리스트 및 미디어 매핑
    const sections = ['overall','Google','Meta','Naver','NaverGFA'];
    const mediaMap = {
      overall: ['Google','Meta','Naver','Naver GFA'],
      Google:  ['Google'],
      Meta:    ['Meta'],
      Naver:   ['Naver'],
      NaverGFA:['Naver GFA']
    };
    // 샘플 데이터 준비
    const sampleData = {};
    sections.forEach(sec => {
      // 단기/장기데이터 생성
      sampleData[sec] = {
        short: dailyDates.map(date => {
          const spend = Math.floor(Math.random()*400000)+100000;
          const impr  = Math.floor(spend*2 + Math.random()*10000);
          const clicks= Math.floor(impr*(Math.random()*0.02+0.01));
          const conv  = Math.floor(clicks*(Math.random()*0.2+0.05));
          const revenue = Math.floor(conv*(Math.random()*50000+20000));
          return { period: date, spend, impr, clicks, conv, revenue,
            roas: +(revenue/spend*100).toFixed(1),
            cpm: +(spend/impr*1000).toFixed(1),
            cpc: clicks?+(spend/clicks).toFixed(1):0,
            ctr: +(clicks/impr*100).toFixed(2),
            cpa: conv?+(spend/conv).toFixed(1):0,
            cvr: clicks?+((conv/clicks)*100).toFixed(2):0
          };
        }),
        long: weeklyLabels.map(w => {
          const spend = Math.floor(Math.random()*2000000)+500000;
          const impr  = Math.floor(spend*2 + Math.random()*50000);
          const clicks= Math.floor(impr*(Math.random()*0.02+0.01));
          const conv  = Math.floor(clicks*(Math.random()*0.2+0.05));
          const revenue = Math.floor(conv*(Math.random()*50000+20000));
          return { period: w, spend, impr, clicks, conv, revenue,
            roas: +(revenue/spend*100).toFixed(1),
            cpm: +(spend/impr*1000).toFixed(1),
            cpc: clicks?+(spend/clicks).toFixed(1):0,
            ctr: +(clicks/impr*100).toFixed(2),
            cpa: conv?+(spend/conv).toFixed(1):0,
            cvr: clicks?+((conv/clicks)*100).toFixed(2):0
          };
        })
      };
    });
    const termMode = Object.fromEntries(sections.map(s=>[s,'short']));
  </script>

  <script>
    // 각 섹션 HTML 생성
    sections.forEach(sec => {
      const title = sec==='overall'? '전체' : sec.replace('GFA',' GFA');
      document.write(`
        <div class="section" id="section-${sec}">
          <h2>${title}</h2>
          <div class="term-toggle" id="${sec}Toggle">
            <button id="${sec}ShortBtn">단기(7일)</button>
            <button id="${sec}LongBtn">장기(8주)</button>
          </div>
          <div class="charts">
            <div class="chart-container"><canvas id="${sec}TrendChart"></canvas></div>
            <div class="chart-container"><canvas id="${sec}ChannelChart"></canvas></div>
          </div>
          <table id="${sec}SummaryTable" class="display"></table>
          <table id="${sec}PeriodTable">
            <thead><tr id="${sec}PeriodHeader"></tr></thead>
            <tbody></tbody>
          </table>
          <div><strong>인사이트 (${title}):</strong>
            <textarea id="${sec}Insight" class="insight" placeholder="${title} 인사이트 작성..."></textarea>
          </div>
        </div>
      `);
    });
  </script>

  <script>
    function renderSection(sec) {
      const arr = sampleData[sec][termMode[sec]];
      const labels = arr.map(d=>d.period);
      const spend  = arr.map(d=>d.spend);
      const roas   = arr.map(d=>d.roas);
      // Trend Chart
      new Chart(document.getElementById(`${sec}TrendChart`),{
        data:{labels,datasets:[
          {type:'bar',label:'광고비용',data:spend,yAxisID:'y',backgroundColor:'rgba(59,123,246,0.5)'},
          {type:'line',label:'ROAS(%)',data:roas,yAxisID:'y1',borderColor:'rgba(246,88,59,0.8)',fill:false}
        ]},options:{responsive:true,scales:{y:{title:{display:true,text:'광고비용'}},y1:{position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'ROAS(%)'}}}}
      });
      // Channel Chart
      const medias = mediaMap[sec];
      const spendBy = medias.map(m=>arr.reduce((s,d)=>s+d.spend,0));
      const revBy   = medias.map(m=>arr.reduce((s,d)=>s+d.revenue,0));
      new Chart(document.getElementById(`${sec}ChannelChart`),{
        data:{labels:medias,datasets:[
          {label:'광고비용',type:'bar',data:spendBy,yAxisID:'y',backgroundColor:'rgba(59,146,64,0.6)'},
          {label:'매출액',  type:'bar',data:revBy,  yAxisID:'y1',backgroundColor:'rgba(64,150,199,0.6)'}
        ]},options:{responsive:true,scales:{y:{title:{display:true,text:'광고비용'}},y1:{position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'매출액'}}}}
      });
      // Summary Table
      const sum = arr.reduce((acc,d)=>{
        acc.spend   += d.spend;
        acc.impr    += d.impr;
        acc.clicks  += d.clicks;
        acc.conv    += d.conv;
        acc.revenue += d.revenue;
        acc.roas    += d.roas;
        acc.cpm     += d.cpm;
        acc.cpc     += d.cpc;
        acc.ctr     += d.ctr;
        acc.cpa     += d.cpa;
        acc.cvr     += d.cvr;
        return acc;
      },{spend:0,impr:0,clicks:0,conv:0,revenue:0,roas:0,cpm:0,cpc:0,ctr:0,cpa:0,cvr:0});
      const avgRoas = (sum.roas/arr.length).toFixed(1);
      const avgCpm  = (sum.cpm/arr.length).toFixed(1);
      const avgCpc  = (sum.cpc/arr.length).toFixed(1);
      const avgCtr  = (sum.ctr/arr.length).toFixed(2);
      const avgCpa  = (sum.cpa/arr.length).toFixed(1);
      const avgCvr  = (sum.cvr/arr.length).toFixed(2);
      const tbody = `<tr>
        <td class="dt-center">Client A</td>
        <td class="dt-center">${sec==='overall'?'전체':sec.replace('GFA',' GFA')}</td>
        <td class="dt-right">${sum.spend.toLocaleString()}</td>
        <td class="dt-right">${sum.impr.toLocaleString()}</td>
        <td class="dt-right">${sum.clicks.toLocaleString()}</td>
        <td class="dt-right">${sum.conv.toLocaleString()}</td>
        <td class="dt-right">${sum.revenue.toLocaleString()}</td>
        <td class="dt-right">${avgRoas}</td>
        <td class="dt-right">${avgCpm}</td>
        <td class="dt-right">${avgCpc}</td>
        <td class="dt-right">${avgCtr}</td>
        <td class="dt-right">${avgCpa}</td>
        <td class="dt-right">${avgCvr}</td>
      </tr>`;
      const summaryTable = $(`#${sec}SummaryTable`).DataTable({ destroy:true });
      summaryTable.clear();
      summaryTable.rows.add([['Client A', sec==='overall'?'전체':sec.replace('GFA',' GFA'),
        sum.spend,sum.impr,sum.clicks,sum.conv,sum.revenue,avgRoas,avgCpm,avgCpc,avgCtr,avgCpa,avgCvr
      ]]).draw();
      // Ensure columns aligned
      summaryTable.columns().every(function(idx){
        $(this.header()).css('text-align', idx<2?'center':'right');
      });
      // Period Table
      const ptbody = document.querySelector(`#${sec}PeriodTable tbody`);
      const pthead = document.getElementById(`${sec}PeriodHeader`);
      pthead.innerHTML = `
        <th class="dt-center">기간</th>
        <th class="dt-right">광고비용</th>
        <th class="dt-right">노출수</th>
        <th class="dt-right">클릭수</th>
        <th class="dt-right">구매수</th>
        <th class="dt-right">매출액</th>
        <th class="dt-right">ROAS(%)</th>
        <th class="dt-right">CPM</th>
        <th class="dt-right">CPC</th>
        <th class="dt-right">CTR(%)</th>
        <th class="dt-right">CPA</th>
        <th class="dt-right">CVR(%)</th>
      `;
      ptbody.innerHTML = arr.map(d=>`
        <tr>
          <td class="dt-center">${d.period}</td>
          <td class="dt-right">${d.spend.toLocaleString()}</td>
          <td class="dt-right">${d.impr.toLocaleString()}</td>
          <td class="dt-right">${d.clicks.toLocaleString()}</td>
          <td class="dt-right">${d.conv.toLocaleString()}</td>
          <td class="dt-right">${d.revenue.toLocaleString()}</td>
          <td class="dt-right">${d.roas.toLocaleString()}</td>
          <td class="dt-right">${d.cpm.toLocaleString()}</td>
          <td class="dt-right">${d.cpc.toLocaleString()}</td>
          <td class="dt-right">${d.ctr.toLocaleString()}</td>
          <td class="dt-right">${d.cpa.toLocaleString()}</td>
          <td class="dt-right">${d.cvr.toLocaleString()}</td>
        </tr>
      `).join('');
    }

    $(document).ready(function(){
      // Summary tables init
      sections.forEach(sec => {
        $(`#${sec}SummaryTable`).DataTable({
          columns: [
            { title:'Client'  },{ title:'Media'   },{ title:'광고비용' },
            { title:'노출수' },{ title:'클릭수' },{ title:'구매수' },
            { title:'매출액' },{ title:'ROAS(%)'},{ title:'CPM'     },
            { title:'CPC'     },{ title:'CTR(%)' },{ title:'CPA'     },
            { title:'CVR(%)' }
          ],
          ordering:false,paging:false,info:false,searching:false
        });
        $(`#${sec}ShortBtn, #${sec}LongBtn`).click(function(){
          termMode[sec] = this.id.endsWith('ShortBtn')?'short':'long';
          $(`#${sec}Toggle button`).removeClass('active');
          $(this).addClass('active');
          renderSection(sec);
        });
        $(`#${sec}ShortBtn`).addClass('active');
        renderSection(sec);
      });
    });
  </script>
</body>
</html>
